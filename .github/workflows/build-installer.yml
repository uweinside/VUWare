name: Build Installer

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0'

env:
  DOTNET_VERSION: '8.0.x'
  BUILD_CONFIGURATION: Release
  SOLUTION_FILE: VUWare.sln

jobs:
  build-installer:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Install Inno Setup
      run: |
        choco install innosetup -y --no-progress
        # Verify installation
        $isccPath = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
        if (Test-Path $isccPath) {
          Write-Host "Inno Setup installed successfully at: $isccPath"
        } else {
          Write-Error "Inno Setup installation failed"
          exit 1
        }
      shell: pwsh
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}
    
    - name: Determine version
      id: version
      run: |
        # Use manual input version if provided, otherwise generate from date/commit
        if ("${{ github.event.inputs.version }}" -ne "") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          # Generate version: 1.0.YYMMDD.buildnumber (e.g., 1.0.241225.123)
          $date = Get-Date -Format "yyMMdd"
          $runNumber = "${{ github.run_number }}"
          $version = "1.0.$date.$runNumber"
        }
        Write-Host "Using version: $version"
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "BUILD_VERSION=$version" >> $env:GITHUB_ENV
      shell: pwsh
    
    - name: Build installer
      run: |
        cd Installer
        .\build-installer.ps1 -Version "${{ steps.version.outputs.version }}" -Verbose
      shell: pwsh
    
    - name: List output files
      run: |
        Write-Host "Installer output files:"
        Get-ChildItem Installer\Output -Filter *.exe | ForEach-Object {
          $sizeMB = [math]::Round($_.Length / 1MB, 2)
          Write-Host "  $($_.Name) - $sizeMB MB"
        }
      shell: pwsh
    
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: VUWare-Installer-${{ steps.version.outputs.version }}
        path: Installer/Output/*.exe
        retention-days: 30
        if-no-files-found: error
    
    - name: Upload build summary
      if: always()
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $installerPath = "Installer/Output"
        
        # Create summary
        echo "## Build Summary" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "**Version:** $version" >> $env:GITHUB_STEP_SUMMARY
        echo "**Configuration:** ${{ env.BUILD_CONFIGURATION }}" >> $env:GITHUB_STEP_SUMMARY
        echo "**Runtime:** win-x64" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        
        # List installer files
        if (Test-Path $installerPath) {
          $files = Get-ChildItem $installerPath -Filter *.exe
          if ($files.Count -gt 0) {
            echo "### Installer Files" >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            foreach ($file in $files) {
              $sizeMB = [math]::Round($file.Length / 1MB, 2)
              echo "- ``$($file.Name)`` ($sizeMB MB)" >> $env:GITHUB_STEP_SUMMARY
            }
          }
        }
      shell: pwsh
